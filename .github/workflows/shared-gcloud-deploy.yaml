name: Shared - Google Cloud Run Deployment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (staging or production)'
        required: true
        type: string
      service-name:
        description: 'Cloud Run service name'
        required: true
        type: string
      image-name:
        description: 'Docker image name'
        required: true
        type: string
      region:
        description: 'Google Cloud region'
        required: false
        type: string
        default: 'us-central1'
      artifact-region:
        description: 'Google Artifact Registry region for image push/pull'
        required: false
        type: string
        default: 'us-central1'
      node-env:
        description: 'NODE_ENV value'
        required: false
        type: string
        default: 'production'
      static-bucket-name:
        description: 'Optional public static bucket name for CDN asset upload'
        required: false
        type: string
        default: ''
      static-cache-control:
        description: 'Cache-Control header to apply to uploaded static assets'
        required: false
        type: string
        default: 'public, max-age=31536000, immutable'
      promote-static-from-bucket:
        description: 'Optional source bucket used to copy static assets into static-bucket-name when not rebuilding'
        required: false
        type: string
        default: ''
      build-and-push-image:
        description: 'Whether this job should build and push the Docker image'
        required: false
        type: boolean
        default: true
      allow-unauthenticated:
        description: 'Whether Cloud Run service should allow unauthenticated direct invocations'
        required: false
        type: boolean
        default: true
      cloud-run-flags:
        description: 'Additional flags passed to gcloud run deploy (for example --ingress internal-and-cloud-load-balancing)'
        required: false
        type: string
        default: ''
      image-uri:
        description: 'Optional full image URI to deploy (overrides computed image URI)'
        required: false
        type: string
        default: ''
    secrets:
      gcp-credentials:
        description: 'Google Cloud credentials JSON'
        required: true
      gcp-project-id:
        description: 'Google Cloud project ID'
        required: true
      database-url:
        description: 'Database URL for migrations and runtime'
        required: true
      supabase-url:
        description: 'Supabase URL'
        required: true
      supabase-key:
        description: 'Supabase Key'
        required: true
      google-cloud-storage-private-bucket:
        description: 'Google Cloud Storage private bucket name'
        required: true
      application-url:
        description: 'Application URL'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up pnpm
        if: ${{ inputs.build-and-push-image }}
        uses: pnpm/action-setup@v4

      - name: Set up Node.js
        if: ${{ inputs.build-and-push-image }}
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp-credentials }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      - name: Install dependencies for static build
        if: ${{ inputs.build-and-push-image }}
        run: pnpm install --frozen-lockfile

      - name: Build application artifacts
        if: ${{ inputs.build-and-push-image }}
        run: pnpx nx build-ci vectreal-platform

      - name: Upload static client assets to GCS
        if: ${{ inputs.static-bucket-name != '' && inputs.build-and-push-image }}
        run: |
          gsutil -m rsync -r -d build/apps/vectreal-platform/client gs://${{ inputs.static-bucket-name }}
          gsutil -m setmeta -h "Cache-Control:${{ inputs.static-cache-control }}" "gs://${{ inputs.static-bucket-name }}/**"

      - name: Promote static assets between buckets
        if: ${{ inputs.static-bucket-name != '' && !inputs.build-and-push-image && inputs.promote-static-from-bucket != '' }}
        run: |
          gsutil -m rsync -r -d gs://${{ inputs.promote-static-from-bucket }} gs://${{ inputs.static-bucket-name }}
          gsutil -m setmeta -h "Cache-Control:${{ inputs.static-cache-control }}" "gs://${{ inputs.static-bucket-name }}/**"

      - name: Log in to Google Artifact Registry
        if: ${{ inputs.build-and-push-image }}
        run: |
          gcloud auth configure-docker ${{ inputs.artifact-region }}-docker.pkg.dev

      - name: Build and push Docker image
        if: ${{ inputs.build-and-push-image }}
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/vectreal-platform/Dockerfile
          target: runner
          push: true
          tags: |
            ${{ inputs.artifact-region }}-docker.pkg.dev/${{ secrets.gcp-project-id }}/vectreal-platform/${{ inputs.image-name }}:${{ github.sha }}
            ${{ inputs.environment == 'production' && format('{0}-docker.pkg.dev/{1}/vectreal-platform/{2}:latest', inputs.artifact-region, secrets.gcp-project-id, inputs.image-name) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=${{ inputs.node-env }}

      - name: Resolve image URI
        id: image
        run: |
          if [ -n "${{ inputs.image-uri }}" ]; then
            echo "uri=${{ inputs.image-uri }}" >> "$GITHUB_OUTPUT"
          else
            echo "uri=${{ inputs.artifact-region }}-docker.pkg.dev/${{ secrets.gcp-project-id }}/vectreal-platform/${{ inputs.image-name }}:${{ github.sha }}" >> "$GITHUB_OUTPUT"
          fi

      - name: Deploy to Cloud Run
        id: deploy
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ inputs.service-name }}
          image: ${{ steps.image.outputs.uri }}
          region: ${{ inputs.region }}
          flags: ${{ format('{0} {1}', inputs.allow-unauthenticated && '--allow-unauthenticated' || '', inputs.cloud-run-flags) }}
          env_vars: |
            NODE_ENV=${{ inputs.node-env }}
            ENVIRONMENT=${{ inputs.environment }}
            GOOGLE_CLOUD_PROJECT=${{ secrets.gcp-project-id }}
            DATABASE_URL=${{ secrets.database-url }}
            SUPABASE_URL=${{ secrets.supabase-url }}
            SUPABASE_KEY=${{ secrets.supabase-key }}
            GOOGLE_CLOUD_STORAGE_PRIVATE_BUCKET=${{ secrets.google-cloud-storage-private-bucket }}
            APPLICATION_URL=${{ secrets.application-url }}

      - name: Verify deployment health
        run: |
          echo "Waiting for service to become healthy..."
          sleep 20

          # If Cloud Run is ingress-restricted to internal-and-cloud-load-balancing,
          # GitHub runners cannot reach the direct *.run.app URL.
          USE_APPLICATION_URL=false
          if [[ "${{ inputs.cloud-run-flags }}" == *"internal-and-cloud-load-balancing"* ]]; then
            USE_APPLICATION_URL=true
          fi

          if [ "$USE_APPLICATION_URL" = "true" ]; then
            SERVICE_URL="${{ secrets.application-url }}"
            echo "Health check target: application URL (LB/edge)"
          elif [ "${{ inputs.allow-unauthenticated }}" = "true" ]; then
            SERVICE_URL="${{ steps.deploy.outputs.url }}"
            echo "Health check target: Cloud Run service URL"
          else
            SERVICE_URL="${{ secrets.application-url }}"
            echo "Health check target: application URL (authenticated service)"
          fi

          HEALTHCHECK_URL="${SERVICE_URL%/}/health"
          echo "Health check URL: $HEALTHCHECK_URL"

          # Try health check endpoint
          MAX_RETRIES=8
          RETRY_COUNT=0

          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "Health check attempt $((RETRY_COUNT + 1))/$MAX_RETRIES..."
            
            if curl -f -s "$HEALTHCHECK_URL" > /dev/null 2>&1; then
              echo "✅ Service is healthy!"
              exit 0
            fi
            
            RETRY_COUNT=$((RETRY_COUNT + 1))
            if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
              echo "⏳ Waiting 15 seconds before retry..."
              sleep 15
            fi
          done

          echo "❌ Service health check failed after $MAX_RETRIES attempts"
          echo "::warning::Deployment completed but health check failed. Please verify manually."
          exit 0  # Don't fail the workflow, but warn

      - name: Output deployment info
        run: |
          echo "::notice::✅ Deployed to ${{ inputs.environment }} environment"
          echo "::notice::Service: ${{ inputs.service-name }}"
          echo "::notice::Region: ${{ inputs.region }}"
          echo "::notice::Image: ${{ steps.image.outputs.uri }}"
