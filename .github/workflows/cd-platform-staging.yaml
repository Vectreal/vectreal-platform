name: Deploy Platform to Staging

on:
  push:
    branches:
      - develop
    paths:
      - 'apps/vectreal-platform/**'
      - 'packages/core/**'
      - 'packages/hooks/**'
      - 'packages/viewer/**'
      - 'shared/**'
      - 'package.json'
      - 'pnpm-lock.yaml'
      - 'nx.json'
      - 'tsconfig.base.json'
      - '.github/workflows/ci-lint-build.yaml'
      - '.github/workflows/cd-platform-staging.yaml'
      - '.github/workflows/shared-gcloud-deploy.yaml'
  workflow_run:
    workflows:
      - CI - Lint and Build
    types:
      - completed
    branches:
      - develop

concurrency:
  group: ${{ github.workflow }}-${{ github.event.workflow_run.head_branch || github.ref }}
  cancel-in-progress: true

jobs:
  deploy-staging:
    name: Deploy to Staging Environment
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    uses: ./.github/workflows/shared-gcloud-deploy.yaml
    with:
      environment: staging
      service-name: vectreal-platform-staging
      image-name: vectreal-platform-staging
      region: us-central1
      artifact-region: us-central1
      node-env: staging
      static-bucket-name: 'vectreal-static-staging'
      static-cache-control: 'public, max-age=31536000, immutable'
    secrets:
      gcp-credentials: ${{ secrets.GCP_CREDENTIALS_STAGING }}
      gcp-project-id: ${{ secrets.GCP_PROJECT_ID_STAGING }}
      database-url: ${{ secrets.DATABASE_URL_STAGING }}
      supabase-url: ${{ secrets.SUPABASE_URL_STAGING }}
      supabase-key: ${{ secrets.SUPABASE_KEY_STAGING }}
      google-cloud-storage-private-bucket: ${{ secrets.GOOGLE_CLOUD_STORAGE_PRIVATE_BUCKET_STAGING }}
      application-url: ${{ secrets.APPLICATION_URL_STAGING }}

  deploy-staging-secondary-us-east1:
    name: Deploy Staging Secondary (us-east1)
    if: ${{ github.event_name == 'push' || github.event.workflow_run.conclusion == 'success' }}
    needs: deploy-staging
    uses: ./.github/workflows/shared-gcloud-deploy.yaml
    with:
      environment: staging
      service-name: vectreal-platform-staging-us-east1
      image-name: vectreal-platform-staging
      region: us-east1
      artifact-region: us-central1
      node-env: staging
      build-and-push-image: false
      static-bucket-name: ''
      static-cache-control: 'public, max-age=31536000, immutable'
    secrets:
      gcp-credentials: ${{ secrets.GCP_CREDENTIALS_STAGING }}
      gcp-project-id: ${{ secrets.GCP_PROJECT_ID_STAGING }}
      database-url: ${{ secrets.DATABASE_URL_STAGING }}
      supabase-url: ${{ secrets.SUPABASE_URL_STAGING }}
      supabase-key: ${{ secrets.SUPABASE_KEY_STAGING }}
      google-cloud-storage-private-bucket: ${{ secrets.GOOGLE_CLOUD_STORAGE_PRIVATE_BUCKET_STAGING }}
      application-url: ${{ secrets.APPLICATION_URL_STAGING }}
