name: Shared Google Cloud Run Deployment

on:
  workflow_call:
    inputs:
      environment:
        description: 'Deployment environment (staging or production)'
        required: true
        type: string
      service-name:
        description: 'Cloud Run service name'
        required: true
        type: string
      image-name:
        description: 'Docker image name'
        required: true
        type: string
      region:
        description: 'Google Cloud region'
        required: false
        type: string
        default: 'us-central1'
      node-env:
        description: 'NODE_ENV value'
        required: false
        type: string
        default: 'production'
    secrets:
      gcp-credentials:
        description: 'Google Cloud credentials JSON'
        required: true
      gcp-project-id:
        description: 'Google Cloud project ID'
        required: true

jobs:
  deploy:
    runs-on: ubuntu-22.04
    environment: ${{ inputs.environment }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Authenticate to Google Cloud
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.gcp-credentials }}

      - name: Log in to Google Container Registry
        uses: docker/login-action@v3
        with:
          registry: gcr.io
          username: _json_key
          password: ${{ secrets.gcp-credentials }}

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./apps/vectreal-platform/Dockerfile
          target: runner
          push: true
          tags: |
            gcr.io/${{ secrets.gcp-project-id }}/${{ inputs.image-name }}:${{ github.sha }}
            ${{ inputs.environment == 'production' && format('gcr.io/{0}/{1}:latest', secrets.gcp-project-id, inputs.image-name) || '' }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          build-args: |
            NODE_ENV=${{ inputs.node-env }}

      - name: Deploy to Cloud Run
        uses: google-github-actions/deploy-cloudrun@v2
        with:
          service: ${{ inputs.service-name }}
          image: gcr.io/${{ secrets.gcp-project-id }}/${{ inputs.image-name }}:${{ github.sha }}
          region: ${{ inputs.region }}
          env_vars: |
            NODE_ENV=${{ inputs.node-env }}
            ENVIRONMENT=${{ inputs.environment }}

      - name: Output deployment info
        run: |
          echo "::notice::âœ… Deployed to ${{ inputs.environment }} environment"
          echo "::notice::Service: ${{ inputs.service-name }}"
          echo "::notice::Region: ${{ inputs.region }}"
          echo "::notice::Image: gcr.io/${{ secrets.gcp-project-id }}/${{ inputs.image-name }}:${{ github.sha }}"
